# 插件打包配置说明

本文档说明如何配置 Maven 插件打包，实现以下目标：

1. **打包为胖 JAR**：将所有依赖打包到插件 JAR 中
2. **合并 META-INF/spring.factories**：确保所有依赖中的 `META-INF/spring.factories` 文件被正确合并到插件 JAR 中

## 1. Maven Shade Plugin 配置

使用 `maven-shade-plugin` 来创建包含所有依赖的胖 JAR，并合并 Spring 相关的配置文件。

### 1.1 基本配置

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-shade-plugin</artifactId>
    <executions>
        <execution>
            <id>plugin-jar</id>
            <phase>package</phase>
            <goals>
                <goal>shade</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

### 1.2 完整配置

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-shade-plugin</artifactId>
    <executions>
        <execution>
            <id>default</id>
            <phase>none</phase>
        </execution>
        <execution>
            <id>plugin-jar</id>
            <phase>package</phase>
            <goals>
                <goal>shade</goal>
            </goals>
            <configuration>
                <createDependencyReducedPom>false</createDependencyReducedPom>
                <filters>
                    <filter>
                        <artifact>*:*</artifact>
                        <excludes>
                            <!-- 排除签名文件 -->
                            <exclude>META-INF/*.SF</exclude>
                            <exclude>META-INF/*.DSA</exclude>
                            <exclude>META-INF/*.RSA</exclude>
                            <!-- 排除 org.laxture 包下的所有类 -->
                            <exclude>org/laxture/**</exclude>
                        </excludes>
                    </filter>
                </filters>
                <transformers>
                    <!-- 合并 META-INF/spring.factories 文件 -->
                    <transformer implementation="org.apache.maven.plugins.shade.resource.AppendingTransformer">
                        <resource>META-INF/spring.factories</resource>
                    </transformer>
                    <!-- 合并 META-INF/spring-autoconfigure-metadata.properties 文件 -->
                    <transformer implementation="org.apache.maven.plugins.shade.resource.AppendingTransformer">
                        <resource>META-INF/spring-autoconfigure-metadata.properties</resource>
                    </transformer>
                    <!-- 合并 META-INF/spring.handlers 文件 -->
                    <transformer implementation="org.apache.maven.plugins.shade.resource.AppendingTransformer">
                        <resource>META-INF/spring.handlers</resource>
                    </transformer>
                    <!-- 合并 META-INF/spring.schemas 文件 -->
                    <transformer implementation="org.apache.maven.plugins.shade.resource.AppendingTransformer">
                        <resource>META-INF/spring.schemas</resource>
                    </transformer>
                    <!-- 设置 MANIFEST.MF -->
                    <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                        <manifestEntries>
                            <Plugin-Id>activity-plugin</Plugin-Id>
                            <Plugin-Version>1.0.0</Plugin-Version>
                            <Plugin-Class>com.gaoding.ska.activity.plugin.ActivityPlugin</Plugin-Class>
                            <Plugin-Description>活动管理插件</Plugin-Description>
                        </manifestEntries>
                    </transformer>
                </transformers>
            </configuration>
        </execution>
    </executions>
</plugin>
```

## 2. 配置说明

### 2.1 filters 配置

`filters` 用于控制哪些文件应该被包含或排除在最终的 JAR 中：

- **排除签名文件**：`META-INF/*.SF`、`META-INF/*.DSA`、`META-INF/*.RSA` - 这些是 JAR 签名文件，在合并多个 JAR 时会导致冲突
- **排除 org.laxture 包**：`org/laxture/**` - 这是 SBP 框架的包，由主应用提供

### 2.2 transformers 配置

`transformers` 用于在打包过程中转换或合并文件：

#### AppendingTransformer

`AppendingTransformer` 用于合并多个同名文件的内容。这对于 Spring 的配置文件非常重要：

- **META-INF/spring.factories**：Spring Boot 自动配置的关键文件，包含自动配置类的列表
- **META-INF/spring-autoconfigure-metadata.properties**：Spring Boot 自动配置元数据
- **META-INF/spring.handlers**：Spring XML 命名空间处理器
- **META-INF/spring.schemas**：Spring XML Schema 定义

**为什么需要 AppendingTransformer？**

当你的插件依赖多个 JAR 包时，这些 JAR 包可能都包含 `META-INF/spring.factories` 文件。如果不使用 `AppendingTransformer`，maven-shade-plugin 默认只会保留其中一个文件，导致其他文件中的配置丢失。

`AppendingTransformer` 会将所有同名文件的内容合并到一个文件中，确保所有配置都被保留。

#### ManifestResourceTransformer

`ManifestResourceTransformer` 用于设置 JAR 的 `MANIFEST.MF` 文件，添加插件的元数据信息：

- **Plugin-Id**：插件的唯一标识符
- **Plugin-Version**：插件版本号
- **Plugin-Class**：插件的主类（实现 `Plugin` 接口的类）
- **Plugin-Description**：插件描述

## 3. 验证打包结果

### 3.1 检查 META-INF/spring.factories 是否存在

```bash
cd activity-plugin/target
jar -tf activity-plugin.jar | grep "META-INF/spring"
```

### 3.2 查看 META-INF/spring.factories 的内容

```bash
cd activity-plugin/target
jar -xf activity-plugin.jar META-INF/spring.factories
cat META-INF/spring.factories
```

### 3.3 预期结果

`META-INF/spring.factories` 应该包含所有依赖 JAR 中的配置，例如：

```properties
# 来自 spring-boot-autoconfigure
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\
org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\
...

# 来自其他依赖
org.springframework.context.ApplicationListener=\
com.example.MyApplicationListener
```

## 4. 常见问题

### 4.1 为什么需要禁用默认的 shade 执行？

```xml
<execution>
    <id>default</id>
    <phase>none</phase>
</execution>
```

这是为了避免 maven-shade-plugin 在默认阶段执行，我们只在 `plugin-jar` 这个自定义执行中运行。

### 4.2 为什么设置 createDependencyReducedPom=false？

```xml
<createDependencyReducedPom>false</createDependencyReducedPom>
```

默认情况下，maven-shade-plugin 会生成一个 `dependency-reduced-pom.xml` 文件，包含排除了已打包依赖的 POM。对于插件项目，我们不需要这个文件，所以禁用它。

### 4.3 如何确认 AppendingTransformer 生效？

查看打包后的 `META-INF/spring.factories` 文件，确认它包含了所有依赖的配置。如果只看到一个依赖的配置，说明 `AppendingTransformer` 没有生效。

## 5. 参考资料

- [Maven Shade Plugin 官方文档](https://maven.apache.org/plugins/maven-shade-plugin/)
- [AppendingTransformer 文档](https://maven.apache.org/plugins/maven-shade-plugin/examples/resource-transformers.html#AppendingTransformer)
- [Spring Boot 自动配置原理](https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.auto-configuration)
