# 插件开发指南

本文档介绍如何基于 SBP Spring Boot Starter 开发插件。

## 目录

- [概述](#概述)
- [前置要求](#前置要求)
- [创建插件模块](#创建插件模块)
- [插件类实现](#插件类实现)
- [配置文件](#配置文件)
- [Maven 配置](#maven-配置)
- [构建插件](#构建插件)
- [示例代码](#示例代码)
- [常见问题](#常见问题)
- [最佳实践](#最佳实践)

## 概述

插件是基于 SBP (Spring Boot Plugin) 框架开发的独立功能模块，具有以下特点：

- **独立运行**：每个插件拥有独立的 Spring 应用上下文
- **依赖隔离**：插件的依赖封装在插件 JAR 中，与主应用隔离
- **热更新**：支持动态加载，无需重启主应用
- **标准化**：遵循统一的开发规范和接口

## 前置要求

### 环境要求

- JDK 8（稿定默认 JDK 版本）
- Maven 3.6+
- Spring Boot 2.2.x

### 依赖要求

插件开发需要以下核心依赖：

```xml
<dependency>
    <groupId>org.laxture</groupId>
    <artifactId>sbp-spring-boot-starter</artifactId>
    <scope>provided</scope>
</dependency>
```

**注意**：`sbp-spring-boot-starter` 必须设置为 `provided` 作用域，因为该依赖由主应用提供。

## 创建插件模块

### 1. 创建 Maven 模块

在项目根目录下创建新的 Maven 模块，目录结构如下：

```
your-plugin/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/yourcompany/plugin/
│   │   │       ├── plugin/
│   │   │       │   └── YourPlugin.java      # 插件入口类
│   │   │       ├── config/
│   │   │       │   └── YourPluginConfiguration.java  # Spring 配置类
│   │   │       ├── controller/              # Controller 层
│   │   │       ├── service/                 # Service 层
│   │   │       ├── dao/                     # DAO 层
│   │   │       ├── entity/                  # 实体类
│   │   │       └── dto/                     # DTO 类
│   │   └── resources/
│   │       └── application.yml              # 插件配置文件
└── pom.xml
```

### 2. 配置父 POM

在插件的 `pom.xml` 中配置父 POM：

```xml
<parent>
    <groupId>com.gaoding.ska.customize</groupId>
    <artifactId>ska-plugin-framework-demo</artifactId>
    <version>${revision}</version>
</parent>

<artifactId>your-plugin</artifactId>
<packaging>jar</packaging>
```

## 插件类实现

### 1. 创建插件类

插件类必须继承 `org.laxture.sbp.SpringBootPlugin`，并实现 `createSpringBootstrap()` 方法：

```java
package com.yourcompany.plugin.plugin;

import com.yourcompany.plugin.config.YourPluginConfiguration;
import org.laxture.sbp.SpringBootPlugin;
import org.laxture.sbp.spring.boot.SpringBootstrap;
import org.pf4j.PluginWrapper;

/**
 * 插件入口类
 *
 * @author baiye
 * @since 2024/12/30
 */
public class YourPlugin extends SpringBootPlugin {

    public YourPlugin(PluginWrapper wrapper) {
        super(wrapper);
    }

    @Override
    protected SpringBootstrap createSpringBootstrap() {
        return new SpringBootstrap(this, YourPluginConfiguration.class);
    }

    @Override
    public void start() {
        System.out.println("YourPlugin starting");
        super.start();
    }

    @Override
    public void stop() {
        System.out.println("YourPlugin stopped");
        super.stop();
    }
}
```

### 2. 创建 Spring 配置类

创建配置类用于扫描插件中的组件：

```java
package com.yourcompany.plugin.config;

import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;

/**
 * 插件配置类
 * 
 * 作用：
 * 1. 扫描插件中的组件（Controller、Service、Repository等）
 * 2. 作为SpringBootstrap的配置类参数
 *
 * @author baiye
 * @since 2024/12/30
 */
@Configuration
@ComponentScan(basePackages = "com.yourcompany.plugin")
public class YourPluginConfiguration {

}
```

**重要**：`@ComponentScan` 的 `basePackages` 必须设置为插件的包路径，确保插件中的组件能被扫描到。

## 配置文件

### application.yml

在 `src/main/resources/application.yml` 中配置插件相关配置：

```yaml
spring:
  application:
    name: your-plugin
  datasource:
    url: jdbc:mysql://localhost:3306/your_db?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: root
    password: your_password
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
```

## Maven 配置

### 1. 依赖配置

在 `pom.xml` 中添加必要的依赖：

```xml
<dependencies>
    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- Spring Data JPA -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    
    <!-- SBP Spring Boot Starter (provided) -->
    <dependency>
        <groupId>org.laxture</groupId>
        <artifactId>sbp-spring-boot-starter</artifactId>
        <scope>provided</scope>
    </dependency>
    
    <!-- 数据库驱动 -->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>
    
    <!-- 其他依赖... -->
</dependencies>
```

### 2. Maven Shade Plugin 配置

**重要**：必须使用 `maven-shade-plugin` 将插件的所有依赖打包到插件 JAR 中，实现依赖隔离。

```xml
<build>
    <plugins>
        <!-- Maven Shade Plugin -->
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-shade-plugin</artifactId>
            <version>3.2.4</version>
            <executions>
                <execution>
                    <phase>package</phase>
                    <goals>
                        <goal>shade</goal>
                    </goals>
                    <configuration>
                        <createDependencyReducedPom>false</createDependencyReducedPom>
                        <filters>
                            <filter>
                                <artifact>*:*</artifact>
                                <excludes>
                                    <exclude>META-INF/*.SF</exclude>
                                    <exclude>META-INF/*.DSA</exclude>
                                    <exclude>META-INF/*.RSA</exclude>
                                </excludes>
                            </filter>
                        </filters>
                        <artifactSet>
                            <excludes>
                                <!-- 排除 SBP 依赖，由主应用提供 -->
                                <exclude>org.laxture:sbp-spring-boot-starter</exclude>
                            </excludes>
                        </artifactSet>
                        <transformers>
                            <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                                <manifestEntries>
                                    <!-- 插件元数据 -->
                                    <Plugin-Id>your-plugin</Plugin-Id>
                                    <Plugin-Version>1.0.0</Plugin-Version>
                                    <Plugin-Class>com.yourcompany.plugin.plugin.YourPlugin</Plugin-Class>
                                </manifestEntries>
                            </transformer>
                        </transformers>
                    </configuration>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```

**关键配置说明**：

- `Plugin-Id`：插件唯一标识，必须与插件类名或功能相关
- `Plugin-Version`：插件版本号
- `Plugin-Class`：插件类的全限定名
- `Plugin-Description`：插件描述信息（可选，支持中文）
- `excludes`：排除 `sbp-spring-boot-starter`，因为该依赖由主应用提供

**注意**：
- 通过 `ManifestResourceTransformer` 配置插件元数据后，插件元数据会被写入 JAR 文件的 `META-INF/MANIFEST.MF` 中
- 可以在 `manifestEntries` 中添加 `Plugin-Description` 配置插件描述
- 如果需要在描述中使用中文，建议同时使用 `plugin.properties` 文件（见下方说明）

**中文编码问题解决**：

MANIFEST.MF 文件默认使用 ISO-8859-1 编码，不支持直接写入非 ASCII 字符（如中文）。如果需要在插件描述中使用中文，有两种解决方案：

**方案 1：使用 plugin.properties 文件（推荐）**

`plugin.properties` 文件需要使用 Unicode 转义序列来表示中文，因为 Java 的 `Properties` 类默认使用 ISO-8859-1 编码读取文件：

1. 在 `src/main/resources/plugin.properties` 中配置：
```properties
plugin.id=your-plugin
plugin.version=1.0.0
plugin.provider=your-name
plugin.class=com.yourcompany.plugin.plugin.YourPlugin
plugin.description=\u63d2\u4ef6\u63cf\u8ff0\u4fe1\u606f
```

2. 将中文转换为 Unicode 转义序列：
   - 在线工具：搜索 "Unicode 转义序列转换器"
   - 命令行：`python3 -c "s='中文'; print(''.join(f'\\\\u{ord(c):04x}' for c in s))"`

3. 在 `pom.xml` 中添加 `maven-resources-plugin` 配置（确保资源文件正确处理）：
```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-resources-plugin</artifactId>
    <configuration>
        <encoding>UTF-8</encoding>
    </configuration>
</plugin>
```

4. **可选**：在 `pom.xml` 的 `maven-shade-plugin` 配置中，也可以在 `manifestEntries` 中添加 `Plugin-Description`：
```xml
<manifestEntries>
    <Plugin-Id>your-plugin</Plugin-Id>
    <Plugin-Version>1.0.0</Plugin-Version>
    <Plugin-Class>com.yourcompany.plugin.plugin.YourPlugin</Plugin-Class>
    <Plugin-Description>活动管理插件</Plugin-Description>
</manifestEntries>
```

**注意**：MANIFEST.MF 文件默认使用 ISO-8859-1 编码，直接写入中文可能会导致乱码。PF4J 的读取优先级取决于运行模式：
- **部署模式（Deployment Mode）**：MANIFEST.MF 优先级更高
- **开发模式（Development Mode）**：plugin.properties 优先级更高

因此建议在 `plugin.properties` 中配置描述信息（使用 Unicode 转义序列），以确保在所有模式下都能正确显示中文。

**注意**：虽然 `plugin.properties` 文件本身可以使用 UTF-8 编码保存，但 PF4J 框架使用 Java 标准的 `Properties.load(InputStream)` 方法读取，该方法默认使用 ISO-8859-1 编码。因此需要使用 Unicode 转义序列来表示非 ASCII 字符（如中文）。

**方案 2：使用 Unicode 转义序列（不推荐）**

**注意**：虽然可以在 MANIFEST.MF 中使用 Unicode 转义序列，但 PF4J 在读取时不会自动解析，会返回转义序列字符串（如 `\\u6d3b\\u52a8`），需要在应用层手动解析。因此不推荐使用此方案。

### 3. plugin.properties 文件（可选）

PF4J 框架支持两种方式配置插件元数据：

1. **MANIFEST.MF 方式**：通过 `maven-shade-plugin` 的 `ManifestResourceTransformer` 配置
2. **plugin.properties 方式**：在 `src/main/resources/plugin.properties` 文件中配置

**优先级说明**：

PF4J 根据运行模式选择读取优先级：
- **部署模式（Deployment Mode）**：优先读取 MANIFEST.MF，如果 MANIFEST.MF 中包含完整的插件元数据，则不再读取 plugin.properties
- **开发模式（Development Mode）**：优先读取 plugin.properties，如果 plugin.properties 存在，则优先使用该文件中的配置

**推荐配置方式**：

1. **MANIFEST.MF 方式**（推荐用于生产环境）：
   - 配置更集中，在 `pom.xml` 中统一管理
   - 避免配置文件遗漏或错误
   - 与 Maven 构建流程更好地集成
   - 适合部署模式

2. **plugin.properties 方式**（推荐用于中文描述）：
   - 支持使用 Unicode 转义序列表示中文
   - 适合开发模式
   - 如果需要在描述中使用中文，建议使用此方式

**最佳实践**：

- 在 MANIFEST.MF 中配置基本的插件元数据（Plugin-Id、Plugin-Version、Plugin-Class）
- 在 plugin.properties 中配置插件描述（plugin.description），使用 Unicode 转义序列表示中文
- 这样可以在所有模式下都能正确显示插件信息，同时中文描述也能正确显示

## 构建插件

使用 Maven 构建插件：

```bash
cd your-plugin
mvn clean package
```

构建完成后，插件 JAR 文件位于 `target/your-plugin-1.0-SNAPSHOT.jar`。

## 示例代码

### Controller 示例

```java
package com.yourcompany.plugin.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

/**
 * 示例控制器
 *
 * @author baiye
 * @since 2024/12/30
 */
@RestController
@RequestMapping("/api/your-resource")
public class YourController {

    @GetMapping
    public String hello() {
        return "Hello from plugin!";
    }
}
```

### Service 示例

```java
package com.yourcompany.plugin.service;

import org.springframework.stereotype.Service;

/**
 * 示例服务类
 *
 * @author baiye
 * @since 2024/12/30
 */
@Service
public class YourService {

    public String doSomething() {
        return "Service logic";
    }
}
```

### Repository 示例

```java
package com.yourcompany.plugin.dao;

import com.yourcompany.plugin.entity.YourEntity;
import org.springframework.data.jpa.repository.JpaRepository;

/**
 * 示例 Repository
 *
 * @author baiye
 * @since 2024/12/30
 */
public interface YourRepository extends JpaRepository<YourEntity, Long> {
    
}
```

### Entity 示例

```java
package com.yourcompany.plugin.entity;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

/**
 * 示例实体类
 *
 * @author baiye
 * @since 2024/12/30
 */
@Entity
@Table(name = "your_table")
public class YourEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    // getters and setters...
}
```

## 常见问题

### 1. ClassNotFoundException 或 NoClassDefFoundError

**问题**：插件开发完成后，在主应用中运行时出现 `ClassNotFoundException` 或 `NoClassDefFoundError`。

**原因**：Spring Boot 自动配置类在主应用的类加载器中运行，无法访问插件中的类。

**说明**：这是插件开发中可能遇到的问题。如果插件使用了第三方库（如 HikariCP、MySQL 驱动等），且这些库被 Spring Boot 自动配置类引用，需要告知主应用维护者在主应用的 `pom.xml` 中添加相应依赖。

**示例**：如果插件使用了 HikariCP，需要告知主应用维护者添加：

```xml
<dependency>
    <groupId>com.zaxxer</groupId>
    <artifactId>HikariCP</artifactId>
</dependency>
```

### 2. Bean 无法注入

**问题**：插件中的 Bean 无法被注入。

**原因**：`@ComponentScan` 的包路径配置不正确。

**解决方案**：确保 `@ComponentScan` 的 `basePackages` 包含所有需要扫描的包。

### 3. 数据库连接失败

**问题**：插件无法连接数据库。

**检查项**：
- 数据库配置是否正确（`application.yml`）
- 数据库驱动是否正确打包到插件 JAR 中
- 数据库配置信息（URL、用户名、密码等）是否正确

**注意**：如果使用 Spring Boot 自动配置，可能需要告知主应用维护者在主应用中添加数据库驱动依赖。

## 最佳实践

### 1. 包命名规范

- 使用公司域名作为包名前缀：`com.yourcompany.plugin`
- 插件类放在 `plugin` 包下
- 配置类放在 `config` 包下
- 遵循标准的 MVC 分层结构

### 2. 插件 ID 命名

- 使用小写字母和连字符：`your-plugin`
- 保持唯一性和描述性
- 与插件功能相关

### 3. 依赖管理

- 将插件的所有依赖打包到插件 JAR 中
- 排除 `sbp-spring-boot-starter`（由主应用提供）
- 避免与主应用的依赖冲突

### 4. 配置隔离

- 每个插件使用独立的配置文件
- 使用独立的数据库（如果使用数据库）
- 避免与主应用共享配置

### 5. 错误处理

- 在 `start()` 和 `stop()` 方法中添加日志
- 处理启动和停止过程中的异常
- 提供清晰的错误信息

### 6. 版本管理

- 使用语义化版本号：`1.0.0`
- 在 MANIFEST.MF 中正确配置版本号
- 保持版本号与代码同步

### 7. 测试

- 在插件开发过程中进行充分测试
- 测试插件提供的 API 接口
- 确保插件功能正常运行

## 参考资源

- [SBP Spring Boot Starter 官方文档](https://github.com/laxture/sbp-spring-boot-starter)
- [PF4J 官方文档](https://pf4j.org/)
- [Spring Boot 官方文档](https://spring.io/projects/spring-boot)

## 示例项目

参考 `activity-plugin` 模块了解完整的插件实现示例。

